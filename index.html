<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- FAVICON IMPLEMENTATION: New Icon URLs from psisvh.vercel.app -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://psisvh.vercel.app/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://psisvh.vercel.app/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://psisvh.vercel.app/favicon-16x16.png">
    <link rel="shortcut icon" href="https://psisvh.vercel.app/favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="https://psisvh.vercel.app/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://psisvh.vercel.app/android-chrome-512x512.png">
    
    <title>Paññāsāstra International School - Van Hong (PSIS VH)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#4F46E5', // Indigo-600 for primary elements
                        'accent-yellow': '#FBBF24', // Amber-400 for accents
                        'safe-green': '#10B981', // Emerald-500 for success/safe themes
                        'bg-light': '#F9FAFB',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scroll behavior for smooth navigation */
        html {
            scroll-behavior: smooth;
        }
        /* Style for cheerful shadows */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .card-shadow:hover {
            transform: translateY(-5px);
        }
        /* Ensure the modal content doesn't scroll with the background */
        .modal-content-container {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Style for the SVG background */
        .svg-bg {
            background: linear-gradient(135deg, #FFD700 0%, #FFA07A 100%);
        }
    </style>
</head>
<body class="font-sans bg-bg-light text-gray-800">

    <!-- Telegram Contact Modal (Hidden by default) -->
    <div id="telegram-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] hidden flex items-center justify-center p-4" onclick="closeModal()">
        <!-- Modal content container -->
        <div class="bg-white rounded-xl p-8 max-w-lg w-full transform transition-all duration-300 shadow-2xl modal-content-container" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 class="text-2xl font-bold text-primary-blue">Select a Telegram Contact</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 transition-colors text-3xl leading-none focus:outline-none">&times;</button>
            </div>
            <p class="text-gray-700 mb-6 text-center">Please choose the chat line you wish to contact:</p>
            
            <div class="space-y-4">
                <!-- Telegram Button 1 -->
                <a href="https://t.me/+85516832588" target="_blank" class="block w-full text-center bg-accent-yellow text-primary-blue py-3 px-6 text-lg font-semibold rounded-lg hover:bg-yellow-300 transition duration-300 shadow-md transform hover:scale-[1.02]">
                    <span class="text-xl mr-2">&#9992;</span> Telegram Chat (Line 1)
                </a>
                <!-- Telegram Button 2 -->
                <a href="https://t.me/+85593815888" target="_blank" class="block w-full text-center bg-accent-yellow text-primary-blue py-3 px-6 text-lg font-semibold rounded-lg hover:bg-yellow-300 transition duration-300 transform hover:scale-[1.02]">
                    <span class="text-xl mr-2">&#9992;</span> Telegram Chat (Line 2)
                </a>
                <!-- Telegram Button 3 -->
                <a href="https://t.me/+85589663888" target="_blank" class="block w-full text-center bg-accent-yellow text-primary-blue py-3 px-6 text-lg font-semibold rounded-lg hover:bg-yellow-300 transition duration-300 transform hover:scale-[1.02]">
                    <span class="text-xl mr-2">&#9992;</span> Chat (Line 3)
                </a>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-sm mt-4 focus:outline-none">Close Window</button>
            </div>
        </div>
    </div>
    
    <!-- Navigation Header (Using PSIS VH) -->
    <header class="sticky top-0 z-50 bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <!-- School Logo/Icon - Changed from Apple to Book -->
                <div class="text-3xl font-extrabold text-red-600 transition duration-300 hover:text-primary-blue">
                    &#128218; 
                </div>
                <h1 class="text-xl font-bold text-gray-800 hidden sm:block">PSIS VH</h1>
            </div>
            <!-- Mobile-friendly Navigation Links -->
            <nav class="flex space-x-4 text-sm font-medium">
                <a href="#about" class="text-gray-600 hover:text-primary-blue transition duration-150 p-2 rounded-lg">About</a>
                <a href="#programs" class="text-gray-600 hover:text-primary-blue transition duration-150 p-2 rounded-lg">Programs</a>
                <!-- Added link for the new tool section -->
                <a href="#admin-tool" class="text-gray-600 hover:text-primary-blue transition duration-150 p-2 rounded-lg hidden sm:block">Admin Tool</a> 
                <a href="#contact" class="hidden sm:inline-block bg-primary-blue text-white py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-150 shadow-md">Enroll Now</a>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="hero" class="bg-primary-blue py-12 sm:py-20 lg:py-28 text-white relative overflow-hidden">
        <!-- Cheerful Background Shapes (Visual flair) -->
        <div class="absolute inset-0 z-0 opacity-10">
            <svg class="h-full w-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none">
                <path fill="#ffffff" fill-opacity="0.3" d="M0,192L48,186.7C96,181,192,171,288,181.3C384,192,480,224,576,213.3C672,203,768,149,864,138.7C960,128,1056,160,1152,176C1248,192,1344,192,1392,192L1440,192L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"></path>
            </svg>
        </div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                <!-- Text Content -->
                <div class="text-center lg:text-left">
                    <h2 class="text-4xl sm:text-6xl font-extrabold leading-tight tracking-tight">
                        <span class="text-accent-yellow">Learn with Joy!</span> Grow with Warmth!
                    </h2>
                    <p class="mt-4 text-xl sm:text-2xl font-light opacity-90">
                        Paññāsāstra International School - Van Hong: A nurturing atmosphere for children to grow with confidence and happiness.
                    </p>
                    <a href="#contact" class="mt-8 inline-block bg-accent-yellow text-primary-blue py-3 px-8 text-lg font-semibold rounded-full hover:bg-yellow-300 transition duration-300 transform hover:scale-105 shadow-xl">
                        Schedule a Tour Today!
                    </a>
                </div>
                <!-- Joyful Learner SVG Visual -->
                <div class="hidden lg:flex justify-center">
                    <div class="w-full max-w-sm h-80 svg-bg p-4 rounded-3xl card-shadow flex items-center justify-center shadow-2xl relative overflow-hidden">
                        <!-- Stylized SVG of a happy child -->
                        <svg class="w-full h-full text-white" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="100" height="100" rx="15" fill="none"/>
                            <!-- Happy Face -->
                            <circle cx="50" cy="40" r="25" fill="#FFEAA7"/>
                            <!-- Hair/Hat -->
                            <path d="M70 30 C75 15, 60 10, 50 10 C40 10, 25 15, 30 30 Z" fill="#E65100"/>
                            <!-- Eyes -->
                            <circle cx="42" cy="38" r="3" fill="#4F46E5"/>
                            <circle cx="58" cy="38" r="3" fill="#4F46E5"/>
                            <!-- Smile -->
                            <path d="M40 50 Q50 60, 60 50" stroke="#D32F2F" stroke-width="3" stroke-linecap="round"/>
                            <!-- Body (Playful Overalls) -->
                            <rect x="30" y="60" width="40" height="30" rx="5" fill="#4F46E5"/>
                            <!-- Arms Waving -->
                            <path d="M30 65 Q15 75, 20 85" stroke="#FFEAA7" stroke-width="6" stroke-linecap="round"/>
                            <path d="M70 65 Q85 75, 80 85" stroke="#FFEAA7" stroke-width="6" stroke-linecap="round"/>
                            <!-- Note: Removed the Apple decoration here -->
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- About Us Section -->
    <section id="about" class="py-16 sm:py-24 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Our <span class="text-safe-green">School Overview</span></h2>
                <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">
                    We believe in holistic development, fostering curiosity, creativity, and confidence in all our students.
                </p>
            </div>
            
            <!-- School Range & Curriculum Information -->
            <div class="mt-10 p-6 sm:p-8 bg-primary-blue/10 rounded-xl border-l-4 border-primary-blue text-center max-w-3xl mx-auto">
                <h3 class="text-2xl font-bold text-primary-blue mb-3">Comprehensive Education, Nursery to Grade 12</h3>
                <p class="text-gray-700 font-extrabold text-lg">
                    We proudly offer a **3-LANGUAGE CURRICULUM**: <span class="text-safe-green">Khmer</span>, <span class="text-safe-green">English</span>, and <span class="text-safe-green">Chinese</span>.
                </p>
                <p class="mt-4 text-gray-800 font-bold bg-accent-yellow/50 inline-block px-3 py-1 rounded-lg shadow-md">
                    Accepting Registration Every Day!
                </p>
                <p class="mt-2 text-gray-700 font-medium">
                    Our programs span from **Nursery to Kindergarten (K)** and continue through **Grade 1 to Grade 12**, with full-time and part-time options available.
                </p>
            </div>
            
            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Feature 1 - Icon changed to Book -->
                <div class="p-6 bg-bg-light rounded-2xl card-shadow text-center">
                    <div class="text-4xl text-safe-green mb-4">&#128218;</div>
                    <h3 class="text-xl font-bold text-gray-900">Play-Based Learning</h3>
                    <p class="mt-2 text-gray-600">
                        Children explore concepts through hands-on activities and imaginative play, making education enjoyable.
                    </p>
                </div>
                <!-- Feature 2 -->
                <div class="p-6 bg-bg-light rounded-2xl card-shadow text-center">
                    <div class="text-4xl text-primary-blue mb-4">&#128170;</div>
                    <h3 class="text-xl font-bold text-gray-900">Social-Emotional Growth</h3>
                    <p class="mt-2 text-gray-600">
                        Focuses on empathy, sharing, and communication skills to build strong social foundations.
                    </p>
                </div>
                <!-- Feature 3 -->
                <div class="p-6 bg-bg-light rounded-2xl card-shadow text-center">
                    <div class="text-4xl text-accent-yellow mb-4">&#128218;</div>
                    <h3 class="text-xl font-bold text-gray-900">Individualized Attention</h3>
                    <p class="mt-2 text-gray-600">
                        Small class sizes ensure every child receives the personalized guidance they need to thrive.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Programs/Curriculum Section -->
    <section id="programs" class="py-16 sm:py-24 bg-primary-blue bg-opacity-5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Our <span class="text-primary-blue">Programs</span></h2>
                <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">
                    We offer flexible programs designed for various age groups and developmental stages.
                </p>
            </div>

            <div class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Program 1 -->
                <div class="bg-white p-6 rounded-2xl card-shadow border-t-4 border-safe-green">
                    <h3 class="text-2xl font-bold text-safe-green">Toddler Discovery (2-3 Yrs)</h3>
                    <p class="mt-3 text-gray-600">
                        Focuses on sensory exploration, basic language, and motor skill development in a supportive environment.
                    </p>
                    <ul class="mt-4 space-y-2 text-sm text-gray-700 list-inside">
                        <li>&#x2714; Sensory Bins & Music</li>
                        <li>&#x2714; Basic Routine Building</li>
                    </ul>
                </div>
                <!-- Program 2 -->
                <div class="bg-white p-6 rounded-2xl card-shadow border-t-4 border-primary-blue">
                    <h3 class="text-2xl font-bold text-primary-blue">Pre-K Readiness (3-4 Yrs)</h3>
                    <p class="mt-3 text-gray-600">
                        Introducing letters, numbers, and early math concepts through interactive and creative methods.
                    </p>
                    <ul class="mt-4 space-y-2 text-sm text-gray-700 list-inside">
                        <li>&#x2714; Phonics and Storytelling</li>
                        <li>&#x2714; Group Projects & Art</li>
                    </ul>
                </div>
                <!-- Program 3 -->
                <div class="bg-white p-6 rounded-2xl card-shadow border-t-4 border-accent-yellow">
                    <h3 class="text-2xl font-bold text-accent-yellow">Kindergarten Prep (4-5 Yrs)</h3>
                    <p class="mt-3 text-gray-600">
                        A comprehensive curriculum ensuring students are fully prepared for elementary school success.
                    </p>
                    <ul class="mt-4 space-y-2 text-sm text-gray-700 list-inside">
                        <li>&#x2714; Early Literacy & Math</li>
                        <li>&#x2714; Science & Nature Walks</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- NEW: Gemini-Powered Announcement Draft Tool Section -->
    <section id="admin-tool" class="py-16 sm:py-24 bg-white">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900">
                    <span class="text-primary-blue">School Announcement Draft Tool</span> ✨
                </h2>
                <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">
                    Use the power of AI to instantly generate professional, friendly announcements for parents and staff.
                </p>
            </div>

            <div class="mt-10 p-8 bg-bg-light rounded-2xl card-shadow border-t-4 border-primary-blue">
                <div class="space-y-6">
                    <!-- Input 1: Topic/Key Points -->
                    <div>
                        <label for="announcement-topic" class="block text-lg font-medium text-gray-700 mb-2">1. Key Points/Topic:</label>
                        <textarea id="announcement-topic" rows="4" placeholder="e.g., School closure tomorrow due to bad weather. All classes moved online. Teachers will email instructions by 8am." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition-shadow shadow-inner"></textarea>
                    </div>

                    <!-- Input 2: Tone/Audience -->
                    <div>
                        <label for="announcement-tone" class="block text-lg font-medium text-gray-700 mb-2">2. Desired Audience & Tone:</label>
                        <select id="announcement-tone" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-inner focus:ring-primary-blue focus:border-primary-blue transition">
                            <option value="Warm and Formal (Parents)">Warm and Formal (Parents - Official Email)</option>
                            <option value="Enthusiastic and Cheerful (Students)">Enthusiastic and Cheerful (Students - Assembly)</option>
                            <option value="Concise and Professional (Staff)">Concise and Professional (Staff - Memo)</option>
                            <option value="Urgent and Clear (Emergency)">Urgent and Clear (Emergency - SMS Alert)</option>
                        </select>
                    </div>

                    <!-- Generate Button -->
                    <button id="generate-announcement-btn" class="w-full bg-safe-green text-white py-3 px-6 text-lg font-semibold rounded-full hover:bg-emerald-600 transition duration-300 transform hover:scale-[1.01] shadow-xl">
                        Draft Announcement ✨
                    </button>
                </div>
                
                <!-- Output Area -->
                <div id="announcement-output" class="mt-8">
                    <div class="p-4 text-center text-gray-500 bg-gray-50 rounded-xl border border-gray-200">
                        Your generated announcement draft will appear here.
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Testimonials Section -->
    <section class="py-16 sm:py-24 bg-primary-blue bg-opacity-5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900">What Parents Are Saying</h2>
            </div>
            <div class="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Testimonial 1 -->
                <div class="p-6 bg-bg-light rounded-2xl border-l-4 border-accent-yellow italic text-gray-700 shadow-md">
                    "Since starting at PSIS VH, my son has become more confident and excited about learning. The teachers are fantastic!"
                    <p class="mt-4 font-semibold text-gray-900 text-sm">- Sarah K., Proud Parent</p>
                </div>
                <!-- Testimonial 2 -->
                <div class="p-6 bg-bg-light rounded-2xl border-l-4 border-safe-green italic text-gray-700 shadow-md">
                    "The focus on emotional intelligence is what sold us. Our daughter is thriving socially and academically at PSIS VH. Highly recommend!"
                    <p class="mt-4 font-semibold text-gray-900 text-sm">- David L., Happy Dad</p>
                </div>
                <!-- Testimonial 3 -->
                <div class="p-6 bg-bg-light rounded-2xl border-l-4 border-primary-blue italic text-gray-700 shadow-md">
                    "The school environment feels safe, warm, and truly nurturing. It's the perfect 'home away from home' for our little one."
                    <p class="mt-4 font-semibold text-gray-900 text-sm">- Maria P., Enthusiastic Mom</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact & Call to Action Section -->
    <section id="contact" class="py-16 sm:py-24 bg-primary-blue text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h2 class="text-4xl sm:text-5xl font-extrabold">Ready to Join the PSIS VH Family?</h2>
            <p class="mt-4 text-xl opacity-90 max-w-3xl mx-auto">
                Spaces are limited! Contact us today to learn more about our enrollment process and book a personal visit.
            </p>

            <!-- Contact Buttons (Call and Telegram only) -->
            <div class="mt-8 flex flex-wrap justify-center gap-4 max-w-4xl mx-auto">
                <!-- Call Button -->
                <a href="tel:093815888" class="w-full sm:w-auto flex-grow sm:flex-grow-0 flex items-center justify-center bg-safe-green text-white py-3 px-6 text-lg font-semibold rounded-full hover:bg-emerald-600 transition duration-300 transform hover:scale-105 shadow-xl">
                    Call Us: 093 815 888
                </a>
                
                <!-- SINGLE TELEGRAM BUTTON (Triggers Modal) -->
                <button onclick="openModal()" class="w-full sm:w-auto flex-grow sm:flex-grow-0 flex items-center justify-center bg-accent-yellow text-primary-blue py-3 px-6 text-lg font-semibold rounded-full hover:bg-yellow-300 transition duration-300 transform hover:scale-105 shadow-xl">
                    <span class="text-xl mr-2">&#9992;</span> Chat on Telegram
                </button>
            </div>

            <!-- Map Iframe -->
            <div class="mt-10 w-full max-w-4xl mx-auto rounded-xl overflow-hidden card-shadow">
                <iframe
                    title="School Location Map"
                    src="https://maps.google.com/maps?q=Building%20582,%20National%20Road%201,%20Phum%20Kdai%20Takoy,%20Sangkat%20Veal%20Sbov,%20Khan%20Chbar%20Ampov,%20Phnom%20Penh&t=&z=15&ie=UTF8&iwloc=&output=embed"
                    width="100%"
                    height="300"
                    frameborder="0"
                    style="border:0;"
                    allowfullscreen=""
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
            
            <!-- Directions Button -->
            <a href="https://maps.app.goo.gl/ZPzMsm9VEwvoVb8V8" target="_blank" class="mt-6 inline-block bg-safe-green text-white py-3 px-8 text-lg font-semibold rounded-full hover:bg-emerald-600 transition duration-300 transform hover:scale-105 shadow-xl">
                <span class="text-xl mr-2">&#128205;</span> Get Directions on Google Maps
            </a>


            <!-- Updated Address -->
            <div class="mt-8 text-center text-sm opacity-80">
                <p class="font-bold mb-1">Main Campus Address:</p>
                <p>Building 582, National Road 1, Phum Kdai Takoy, Sangkat Veal Sbov, Khan Chbar Ampov, Phnom Penh</p>
            </div>
        </div>
    </section>

    <!-- --- FACEBOOK MESSENGER CUSTOMER CHAT PLUGIN START --- -->
    <div class="fb-customerchat"
      page_id="PannasastraInternationalSchoolVANHONG.psisvh"
      greeting_dialog_display="fade"
      logged_in_greeting="Welcome back! How can we help your child today?"
      logged_out_greeting="Hi there! Ask us about programs, enrollment, or tours.">
    </div>

    <!-- Footer (Updated Name) -->
    <footer class="bg-gray-800 text-white py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center text-sm flex-col sm:flex-row">
            <p>&copy; 2025 Paññāsāstra International School - Van Hong (PSIS VH). All Rights Reserved.</p>
            <div class="mt-3 sm:mt-0 space-x-4">
                <a href="#" class="hover:text-accent-yellow transition duration-150">Privacy Policy</a>
                <span class="text-gray-600">|</span>
                <a href="#" class="hover:text-accent-yellow transition duration-150">Sitemap</a>
            </div>
        </div>
    </footer>

    <!-- Scripts (Facebook SDK, Modal, LLM Logic, and Firebase Setup) -->
    <script type="module">
        // --- Firebase/LLM Setup (REQUIRED FOR API CALLS) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firestore is not used, so only Auth/App imports are needed

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Use empty string for automatic handling

        // Exponential Backoff function for API robustness
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        throw new Error(`Client error: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        const waitTime = Math.pow(2, i) * 1000;
                        await delay(waitTime);
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Function to call Gemini API for announcement generation
        async function generateAnnouncement(topic, tone) {
            const generateButton = document.getElementById('generate-announcement-btn');
            const outputDiv = document.getElementById('announcement-output');
            
            // Disable button and show loading indicator
            generateButton.disabled = true;
            generateButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Drafting...';

            outputDiv.innerHTML = '<div class="text-center p-4 text-primary-blue bg-blue-50 rounded-xl">Drafting announcement, please wait...</div>';

            const systemPrompt = `You are a helpful and professional school administrator for Paññāsāstra International School. Your task is to draft a clear, concise, and friendly school announcement based on the user's key points. The tone should be ${tone}. Use a formal but warm voice and end the announcement with 'Thank you for your cooperation and support. PSIS VH Administration.'`;

            const userQuery = `Draft an announcement for the school based on the following key points: "${topic}". The target audience/tone is ${tone}. Please make the key dates/times **bold**.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    // Simple markdown text to HTML paragraph conversion (handling bolding from LLM response)
                    const formattedText = generatedText.split('\n').map(p => {
                        if (p.trim() === '') return '';
                        // Replace markdown **bold** with <strong>
                        const cleanP = p.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        return `<p class="mb-3">${cleanP}</p>`;
                    }).join('');
                    
                    outputDiv.innerHTML = `<div class="p-6 bg-green-50 rounded-xl border border-safe-green text-gray-800">${formattedText}</div>`;
                } else {
                    outputDiv.innerHTML = '<div class="p-4 bg-red-100 rounded-xl text-red-700">Sorry, I couldn\'t generate the announcement. Please try again with more details.</div>';
                }
                
            } catch (error) {
                console.error('Gemini API Error:', error);
                outputDiv.innerHTML = '<div class="p-4 bg-red-100 rounded-xl text-red-700">An error occurred while connecting to the drafting service. Please check your network.</div>';
            } finally {
                generateButton.disabled = false;
                generateButton.innerHTML = 'Draft Announcement ✨';
            }
        }

        // --- Core Application Logic ---
        window.openModal = () => {
            document.getElementById('telegram-modal').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        };

        window.closeModal = () => {
            document.getElementById('telegram-modal').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-Scroll to the contact section on load (existing feature)
            const targetElement = document.getElementById('contact');
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            }

            // New event listener for the LLM tool
            const generateButton = document.getElementById('generate-announcement-btn');
            if (generateButton) {
                generateButton.addEventListener('click', () => {
                    const topic = document.getElementById('announcement-topic').value.trim();
                    const tone = document.getElementById('announcement-tone').value;

                    if (topic.length < 10) {
                        document.getElementById('announcement-output').innerHTML = '<div class="p-4 bg-yellow-100 rounded-xl text-yellow-800">Please provide at least 10 characters for the announcement topic.</div>';
                        return;
                    }

                    generateAnnouncement(topic, tone);
                });
            }

            // Firebase init for API proxy authentication
            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).catch(err => {
                        console.error("Firebase custom token sign-in failed:", err);
                        signInAnonymously(auth).catch(anonErr => console.error("Anonymous sign-in failed:", anonErr));
                    });
                } else {
                    signInAnonymously(auth).catch(anonErr => console.error("Anonymous sign-in failed:", anonErr));
                }
            }
        });
    </script>
    <script>
        // Facebook SDK script (standard)
        window.fbAsyncInit = function() {
            FB.init({
                xfbml            : true,
                version          : 'v20.0'
            });
        };

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = 'https://connect.facebook.net/en_US/sdk/xfbml.customerchat.js';
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</body>
</html>
